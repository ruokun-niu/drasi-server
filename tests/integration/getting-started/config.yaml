# Integration test configuration for Drasi Server
# This configuration is used for automated integration tests in CI and can be used locally

server:
  host: 0.0.0.0
  port: 8080
  logLevel: info
  disablePersistence: true

serverCore:
  id: integration-test-server

sources:
  - kind: postgres
    id: postgres-messages
    autoStart: true
    host: localhost
    port: 5432
    database: getting_started
    user: drasi_user
    password: drasi_password
    sslMode: prefer
    tables:
      - message
    slotName: drasi_integration_test_slot
    publicationName: drasi_getting_started_pub
    tableKeys:
      - table: message
        keyColumns:
          - messageid
    bootstrapProvider:
      type: postgres

queries:
  - id: hello-world-from
    auto_start: true
    query: |
      MATCH (m:message)
      WHERE m.message = 'Hello World'
      RETURN m.messageid AS MessageId, m.from AS MessageFrom
    sources:
      - source_id: postgres-messages

  - id: message-count
    auto_start: true
    query: |
      MATCH (m:message)
      RETURN m.message AS Message, count(m) AS Frequency
    sources:
      - source_id: postgres-messages

reactions:
  - kind: log
    id: log-all-queries
    autoStart: true
    queries:
      - hello-world-from
      - message-count
    addedTemplate: "[{{query_name}}] + {{after}}"
    updatedTemplate: "[{{query_name}}] ~ {{before}} -> {{after}}"
    deletedTemplate: "[{{query_name}}] - {{before}}"
