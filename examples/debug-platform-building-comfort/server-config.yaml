# Drasi Platform Example - Redis Stream Integration with Platform Bootstrap
# This example demonstrates using the platform source to consume events from Redis Streams
# with bootstrap data from a Query API service

# Server: Drasi Server configuration
server:
  host: 0.0.0.0
  port: 8080
  logLevel: debug
  disablePersistence: true

serverCore:
  id: debug-platform-building-comfort

# Sources: Define where data comes from
sources:
  # Platform source - connects to Redis Stream to consume events with platform bootstrap
  - kind: platform
    id: facilities-db
    autoStart: true
    # Platform bootstrap provider - fetches initial data from Query API
    # Redis connection URL
    redisUrl: "redis://localhost:6379"

    # Redis stream key to read from
    streamKey: "facilities-db-change"

    # Consumer group name for Redis Streams consumer group
    consumerGroup: "drasi-server"

    # Unique consumer name within the consumer group
    consumerName: "consumer-1"

    # Number of events to read per batch (default: 10)
    batchSize: 10

    # Milliseconds to block waiting for new events (default: 5000)
    blockMs: 5000

    # Stream position: ">" for new events, "0" to replay all (default: ">")
    startId: "0"

    # Always recreate consumer group on startup (default: false)
    # If true, deletes and recreates the consumer group using startId
    # If false, uses existing group position (ignores startId if group exists)
    alwaysCreateConsumerGroup: true

# Queries: Continuous Cypher queries that process incoming data
queries:
  - id: room-comfort-level
    auto_start: true
    query: |
      MATCH
        (r:Room)
      RETURN
        elementId(r) AS RoomId,
        50 + (r.temperature - 72) + (r.humidity - 42) + (r.co2 / 25) AS ComfortLevel
    # Sources this query subscribes to
    sources:
      - facilities-db

# Reactions: Define what happens with query results
reactions:
  # Log reaction - prints query results to console for debugging
  - kind: log
    id: log-room-comfort-level
    autoStart: true
    # Queries this reaction subscribes to
    queries:
      - room-comfort-level

  - kind: profiler
    id: profiler-room-comfort-level
    autoStart: true
    # Queries this reaction subscribes to
    queries:
      - room-comfort-level

  # - kind: platform
  #   id: platform-room-comfort-level
  #   autoStart: true
  #   # Queries this reaction subscribes to
  #   queries:
  #     - room-comfort-level
  #   # Redis connection URL (same Redis instance as platform source)
  #   redisUrl: "redis://localhost:6379"
  #
  #   # Dapr pubsub component name (used in CloudEvent metadata)
  #   pubsubName: "drasi-pubsub"
  #
  #   # Event source identifier (used in CloudEvent source field)
  #   sourceName: "drasi-core"
  #
  #   # Maximum number of messages to retain in the results stream
  #   # Uses Redis MAXLEN with approximate trimming (~)
  #   maxStreamLength: 10000
  #
  #   # Emit lifecycle control events (BootstrapStarted, Running, Stopped, etc.)
  #   emitControlEvents: true
