# Drasi Platform Example - Redis Stream Integration with Platform Bootstrap
# This example demonstrates using the platform source to consume events from Redis Streams
# with bootstrap data from a Query API service

# API: Drasi Server API configuration
api:
  host: 0.0.0.0
  port: 8080

# Server: Drasi Server wrapper runtime configuration
server:
  log_level: info
  disable_persistence: true

# Sources: Define where data comes from
sources:
  # Platform source - connects to Redis Stream to consume events with platform bootstrap
  - id: facilities-db
    source_type: platform
    auto_start: true
    # Platform bootstrap provider - fetches initial data from Query API
    properties:
      # Redis connection URL
      redis_url: "redis://localhost:6379"

      # Redis stream key to read from
      stream_key: "facilities-db-change"

      # Consumer group name for Redis Streams consumer group
      consumer_group: "drasi-server"

      # Unique consumer name within the consumer group
      consumer_name: "consumer-1"

      # Number of events to read per batch (default: 10)
      batch_size: 10

      # Milliseconds to block waiting for new events (default: 5000)
      block_ms: 5000

      # Stream position: ">" for new events, "0" to replay all (default: ">")
      start_id: "0"

      # Always recreate consumer group on startup (default: false)
      # If true, deletes and recreates the consumer group using start_id
      # If false, uses existing group position (ignores start_id if group exists)
      always_create_consumer_group: true

# Queries: Continuous Cypher queries that process incoming data
queries:
  - id: room-comfort-level
    auto_start: true
    query: |
      MATCH
        (r:Room)
      RETURN
        elementId(r) AS RoomId,
        50 + (r.temperature - 72) + (r.humidity - 42) + (r.co2 / 25) AS ComfortLevel
    # Sources this query subscribes to
    sources:
      - facilities-db

# Reactions: Define what happens with query results
reactions:
  # Log reaction - prints query results to console for debugging
  - id: log-room-comfort-level
    reaction_type: log
    auto_start: true
    # Queries this reaction subscribes to
    queries:
      - room-comfort-level